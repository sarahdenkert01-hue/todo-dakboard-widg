<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncPro Dakboard</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --accent-color: #bbfce2; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: transparent; font-family: 'Comfortaa', cursive; color: white; min-height: 100vh; overflow: auto; }

        /* Draggable Container */
        .list-container { 
            position: absolute; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 18px; min-width: 260px; touch-action: none;
        }

        .list-header { cursor: move; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 12px; font-weight: bold; color: var(--accent-color); display: flex; justify-content: space-between; align-items: center; }
        
        /* Functional Icons */
        .icon-btn { width: 13px; height: 13px; opacity: 0.4; cursor: pointer; transition: 0.2s; }
        .icon-btn:hover { opacity: 1; }

        .task-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; }
        .checkbox { width: 13px; height: 13px; border: 1.5px solid white; border-radius: 50%; flex-shrink: 0; cursor: pointer; }
        .checkbox.checked { background: var(--accent-color); border-color: var(--accent-color); }
        
        .input-style { width: 100%; background: rgba(255,255,255,0.08); border: 1px dashed rgba(255,255,255,0.2); color: white; padding: 8px; border-radius: 6px; outline: none; margin-bottom: 12px; font-family: inherit; font-size: 12px; }

        .hide-completed .task-row.completed { display: none; }
        
        #globalToggle { position: fixed; top: 10px; left: 10px; z-index: 9999; background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); font-size: 10px; cursor: pointer; }
    </style>
</head>
<body class="show-completed">

    <button id="globalToggle" onclick="toggleCompleted()">üëÅ Show/Hide Completed</button>
    <div id="dashboardArea"></div>

    <script>
        const S_URL = 'https://gzjakgmvxvkznoeupnat.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6amFrZ212eHZrem5vZXVwbmF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzgxNTgsImV4cCI6MjA4MTYxNDE1OH0.qQGTrXgYWMdqP5NK6zdx75pNqYtb2H7vaQnKpZAvFvI';
        const GITHUB_BASE = "https://raw.githubusercontent.com/username/repo/main/icons/";
        const supabaseClient = window.supabase.createClient(S_URL, S_KEY);

        let lists = [], tasks = [];

        async function loadData() {
            const { data: lData } = await supabaseClient.from('lists').select('*');
            const { data: tData } = await supabaseClient.from('tasks').select('*').order('id');
            lists = lData || [];
            tasks = tData || [];
            renderDashboard();
        }

        function renderDashboard() {
            const area = document.getElementById('dashboardArea');
            area.innerHTML = lists.map(l => {
                const listTasks = tasks.filter(t => t.list_id === l.id);
                const x = l.x_position || 50; 
                const y = l.y_position || 50;
                const w = l.width || 300;

                return `
                <div class="list-container" id="list-${l.id}" style="transform: translate(${x}px, ${y}px); width: ${w}px;" data-x="${x}" data-y="${y}">
                    <div class="list-header">
                        <span># ${l.name}</span>
                        <img src="${GITHUB_BASE}delete.svg" class="icon-btn" onclick="deleteList(${l.id})">
                    </div>
                    
                    <input type="text" placeholder="+ Quick add..." class="input-style" onkeypress="addTask(${l.id}, event)">

                    <div class="task-list">
                        ${listTasks.map(t => `
                            <div class="task-row ${t.completed ? 'completed' : ''}">
                                <div class="checkbox ${t.completed ? 'checked' : ''}" onclick="toggleTask(${t.id}, ${t.completed})"></div>
                                <span style="${t.completed ? 'opacity:0.4; text-decoration:line-through' : ''}">${t.text}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');
            initInteractions();
        }

        // --- DASHBOARD ACTIONS ---
        async function addTask(listId, e) {
            if (e.key === 'Enter' && e.target.value) {
                await supabaseClient.from('tasks').insert([{ list_id: listId, text: e.target.value }]);
                e.target.value = "";
                loadData();
            }
        }

        async function toggleTask(id, s) {
            await supabaseClient.from('tasks').update({ completed: !s }).eq('id', id);
            loadData();
        }

        async function deleteList(id) {
            if(confirm("Delete list?")) {
                await supabaseClient.from('lists').delete().eq('id', id);
                loadData();
            }
        }

        function toggleCompleted() {
            document.body.classList.toggle('hide-completed');
        }

        // --- INTERACT LOGIC ---
        
        function initInteractions() {
            interact('.list-container')
                .draggable({
                    allowFrom: '.list-header',
                    listeners: {
                        move(event) {
                            const target = event.target;
                            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                            target.style.transform = `translate(${x}px, ${y}px)`;
                            target.setAttribute('data-x', x);
                            target.setAttribute('data-y', y);
                        },
                        end(event) { updateSupabase(event.target); }
                    }
                })
                .resizable({
                    edges: { right: true, bottom: true },
                    listeners: {
                        move(event) {
                            event.target.style.width = `${event.rect.width}px`;
                        },
                        end(event) { updateSupabase(event.target); }
                    }
                });
        }

        async function updateSupabase(el) {
            const listId = el.id.split('-')[1];
            await supabaseClient.from('lists').update({ 
                x_position: Math.round(parseFloat(el.getAttribute('data-x'))), 
                y_position: Math.round(parseFloat(el.getAttribute('data-y'))), 
                width: Math.round(el.offsetWidth) 
            }).eq('id', listId);
        }

        window.onload = loadData;
    </script>
</body>
</html>
